---
import type { MemberWithStats } from '../lib/types';
import { formatNumber, formatPercentage, formatRelativeTime, getPRRating, getRoleDisplayName, getRoleColor } from '../lib/utils';

interface Props {
  members: MemberWithStats[];
}

const { members } = Astro.props;
---

<div class="bg-white rounded-lg shadow-lg overflow-hidden">
  <!-- Table Header -->
  <div class="bg-blue-primary text-white px-6 py-4">
    <h2 class="text-2xl font-bold">Clan Roster</h2>
    <p class="text-blue-light text-sm mt-1"><span id="member-count">{members.length}</span> Active Members</p>
  </div>

  <!-- Table -->
  <div class="overflow-x-auto">
    <table class="w-full" id="member-table">
      <thead class="bg-gray-100 border-b-2 border-blue-primary">
        <tr>
          <th class="px-6 py-3 text-left text-xs font-medium text-text-secondary uppercase tracking-wider">
            Rank
          </th>
          <th
            class="px-6 py-3 text-left text-xs font-medium text-text-secondary uppercase tracking-wider cursor-pointer hover:bg-gray-200 transition-colors select-none"
            data-sort="nickname"
          >
            Player
            <span class="sort-indicator ml-1 text-blue-primary opacity-0">▼</span>
          </th>
          <th
            class="px-6 py-3 text-left text-xs font-medium text-text-secondary uppercase tracking-wider cursor-pointer hover:bg-gray-200 transition-colors select-none"
            data-sort="role"
          >
            Role
            <span class="sort-indicator ml-1 text-blue-primary opacity-0">▼</span>
          </th>
          <th
            class="px-6 py-3 text-right text-xs font-medium text-text-secondary uppercase tracking-wider cursor-pointer hover:bg-gray-200 transition-colors select-none"
            data-sort="battles"
          >
            Battles
            <span class="sort-indicator ml-1 text-blue-primary opacity-0">▼</span>
          </th>
          <th
            class="px-6 py-3 text-right text-xs font-medium text-text-secondary uppercase tracking-wider cursor-pointer hover:bg-gray-200 transition-colors select-none"
            data-sort="win_rate"
          >
            Win Rate
            <span class="sort-indicator ml-1 text-blue-primary opacity-0">▼</span>
          </th>
          <th
            class="px-6 py-3 text-right text-xs font-medium text-text-secondary uppercase tracking-wider cursor-pointer hover:bg-gray-200 transition-colors select-none"
            data-sort="avg_damage"
          >
            Avg Damage
            <span class="sort-indicator ml-1 text-blue-primary opacity-0">▼</span>
          </th>
          <th
            class="px-6 py-3 text-right text-xs font-medium text-text-secondary uppercase tracking-wider cursor-pointer hover:bg-gray-200 transition-colors select-none"
            data-sort="pr"
          >
            PR
            <span class="sort-indicator ml-1 text-blue-primary opacity-0">▼</span>
          </th>
          <th
            class="px-6 py-3 text-left text-xs font-medium text-text-secondary uppercase tracking-wider cursor-pointer hover:bg-gray-200 transition-colors select-none"
            data-sort="last_battle_time"
          >
            Last Battle
            <span class="sort-indicator ml-1 text-blue-primary opacity-0">▼</span>
          </th>
        </tr>
      </thead>
      <tbody class="divide-y divide-gray-200">
        {members.map((member, index) => {
          const prRating = getPRRating(member.pr);

          return (
            <tr
              class="hover:bg-gray-50 transition-colors"
              data-nickname={member.nickname}
              data-role={member.role}
              data-battles={member.battles}
              data-win-rate={member.win_rate}
              data-avg-damage={member.avg_damage}
              data-pr={member.pr}
              data-last-battle={member.last_battle_time || 0}
            >
              <!-- Rank -->
              <td class="rank-cell px-6 py-4 whitespace-nowrap text-sm font-medium text-text-primary">
                #{index + 1}
              </td>

              <!-- Player Name -->
              <td class="px-6 py-4 whitespace-nowrap">
                <a
                  href={`/player/${member.account_id}`}
                  class="text-sm font-medium text-blue-secondary hover:text-blue-primary hover:underline"
                >
                  {member.nickname}
                </a>
              </td>

              <!-- Role -->
              <td class="px-6 py-4 whitespace-nowrap">
                <span
                  class="px-2 py-1 text-xs font-semibold rounded"
                  style={`color: ${getRoleColor(member.role)}; background-color: ${getRoleColor(member.role)}20;`}
                >
                  {getRoleDisplayName(member.role)}
                </span>
              </td>

              <!-- Battles -->
              <td class="px-6 py-4 whitespace-nowrap text-right text-sm text-text-primary">
                {member.hidden_profile ? (
                  <span class="text-text-tertiary italic">Hidden</span>
                ) : (
                  formatNumber(member.battles)
                )}
              </td>

              <!-- Win Rate -->
              <td class="px-6 py-4 whitespace-nowrap text-right text-sm">
                {member.hidden_profile ? (
                  <span class="text-text-tertiary italic">-</span>
                ) : (
                  <span class="font-medium text-text-primary">
                    {formatPercentage(member.win_rate)}
                  </span>
                )}
              </td>

              <!-- Avg Damage -->
              <td class="px-6 py-4 whitespace-nowrap text-right text-sm text-text-primary">
                {member.hidden_profile ? (
                  <span class="text-text-tertiary italic">-</span>
                ) : (
                  formatNumber(Math.round(member.avg_damage))
                )}
              </td>

              <!-- PR -->
              <td class="px-6 py-4 whitespace-nowrap text-right text-sm">
                {member.hidden_profile ? (
                  <span class="text-text-tertiary italic">-</span>
                ) : (
                  <span
                    class="px-2 py-1 rounded font-bold text-white text-xs"
                    style={`background-color: ${prRating.color};`}
                    title={prRating.label}
                  >
                    {formatNumber(member.pr)}
                  </span>
                )}
              </td>

              <!-- Last Battle -->
              <td class="px-6 py-4 whitespace-nowrap text-sm text-text-secondary">
                {member.last_battle_time ? formatRelativeTime(member.last_battle_time) : '-'}
              </td>
            </tr>
          );
        })}
      </tbody>
    </table>
  </div>

  {members.length === 0 && (
    <div class="px-6 py-12 text-center text-text-tertiary">
      <p>No members found.</p>
    </div>
  )}
</div>

<script>
  // Client-side table sorting
  const table = document.getElementById('member-table');
  const headers = table?.querySelectorAll('th[data-sort]');
  const tbody = table?.querySelector('tbody');

  let currentSort: string | null = null;
  let currentDirection: 'asc' | 'desc' = 'desc';

  headers?.forEach(header => {
    header.addEventListener('click', () => {
      const sortKey = header.getAttribute('data-sort');
      if (!sortKey || !tbody) return;

      // Toggle direction if clicking same column, otherwise default to descending
      if (currentSort === sortKey) {
        currentDirection = currentDirection === 'desc' ? 'asc' : 'desc';
      } else {
        currentDirection = 'desc';
      }
      currentSort = sortKey;

      // Update all sort indicators
      headers.forEach(h => {
        const indicator = h.querySelector('.sort-indicator');
        if (indicator) {
          if (h === header) {
            indicator.classList.remove('opacity-0');
            indicator.textContent = currentDirection === 'desc' ? '▼' : '▲';
          } else {
            indicator.classList.add('opacity-0');
          }
        }
      });

      // Get all rows and sort them
      const rows = Array.from(tbody.querySelectorAll('tr'));

      rows.sort((a, b) => {
        const aValue = a.getAttribute(`data-${sortKey.replace('_', '-')}`);
        const bValue = b.getAttribute(`data-${sortKey.replace('_', '-')}`);

        // Handle null/empty values
        if (!aValue && !bValue) return 0;
        if (!aValue) return 1;
        if (!bValue) return -1;

        // Determine if numeric or string comparison
        let comparison = 0;
        if (sortKey === 'nickname' || sortKey === 'role') {
          // String comparison
          comparison = aValue.localeCompare(bValue);
        } else {
          // Numeric comparison
          const aNum = parseFloat(aValue);
          const bNum = parseFloat(bValue);
          comparison = aNum - bNum;
        }

        return currentDirection === 'desc' ? -comparison : comparison;
      });

      // Clear and re-append rows
      tbody.innerHTML = '';
      rows.forEach((row, index) => {
        // Update rank numbers
        const rankCell = row.querySelector('.rank-cell');
        if (rankCell) {
          rankCell.textContent = `#${index + 1}`;
        }
        tbody.appendChild(row);
      });
    });
  });
</script>

<style>
  th[data-sort] {
    position: relative;
  }

  th[data-sort]:hover {
    background-color: rgba(0, 0, 0, 0.05);
  }
</style>
