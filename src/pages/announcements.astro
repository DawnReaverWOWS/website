---
import BaseLayout from '../layouts/BaseLayout.astro';
import Navigation from '../components/Navigation.astro';
import Footer from '../components/Footer.astro';
import { db } from '../db';
import { announcements } from '../db/schema';
import { desc, eq } from 'drizzle-orm';

// Fetch public announcements
const publicAnnouncements = await db.select()
  .from(announcements)
  .where(eq(announcements.isPublic, true))
  .orderBy(desc(announcements.isPinned), desc(announcements.createdAt))
  .limit(50);

// Category display names and colors
const categoryInfo: Record<string, { label: string; color: string }> = {
  general: { label: 'General', color: 'text-steel-light' },
  clan_battle: { label: 'Clan Battle', color: 'text-gold-DEFAULT' },
  event: { label: 'Event', color: 'text-cyan-glow' },
  maintenance: { label: 'Maintenance', color: 'text-red-alert' },
};

function formatDate(date: Date): string {
  return new Date(date).toLocaleDateString('en-US', {
    month: 'short',
    day: 'numeric',
    year: 'numeric',
    hour: '2-digit',
    minute: '2-digit',
  });
}
---

<BaseLayout
  title="Announcements - DawnReaver [DAWN]"
  description="Latest updates and announcements from DawnReaver clan leadership."
>
  <Navigation />

  <main class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Page Header -->
    <div class="mb-8 text-center">
      <h1 class="text-4xl xl:text-5xl font-display font-bold text-gold-DEFAULT mb-3 glow-gold uppercase">
        Announcements
      </h1>
      <p class="text-steel-light text-lg">
        Stay updated with the latest clan news and updates
      </p>
    </div>

    <!-- Announcements List -->
    {publicAnnouncements.length === 0 ? (
      <div class="steel-panel p-8 text-center">
        <p class="text-text-secondary text-lg">No announcements yet. Check back soon!</p>
      </div>
    ) : (
      <div class="space-y-4">
        {publicAnnouncements.map((announcement) => {
          const categoryData = categoryInfo[announcement.category || 'general'];

          return (
            <article class:list={[
              'steel-panel p-6',
              announcement.isPinned && 'alert-border'
            ]}>
              <!-- Header -->
              <div class="flex items-start justify-between mb-3">
                <div class="flex-1">
                  <div class="flex items-center gap-3 mb-2">
                    {announcement.isPinned && (
                      <span class="text-gold-DEFAULT text-lg" title="Pinned">üìå</span>
                    )}
                    <h2 class="text-2xl font-display font-bold text-text-primary">
                      {announcement.title}
                    </h2>
                  </div>

                  <div class="flex flex-wrap items-center gap-3 text-sm text-text-secondary">
                    <span class="flex items-center gap-1">
                      <span class="text-cyan-glow">üë§</span>
                      {announcement.author}
                    </span>
                    <span>‚Ä¢</span>
                    <time datetime={announcement.createdAt?.toISOString()}>
                      {formatDate(announcement.createdAt!)}
                    </time>
                    {categoryData && (
                      <>
                        <span>‚Ä¢</span>
                        <span class:list={['font-semibold', categoryData.color]}>
                          {categoryData.label}
                        </span>
                      </>
                    )}
                  </div>
                </div>
              </div>

              <!-- Content -->
              <div class="prose prose-invert prose-steel max-w-none">
                <p class="text-text-secondary whitespace-pre-wrap leading-relaxed">
                  {announcement.content}
                </p>
              </div>
            </article>
          );
        })}
      </div>
    )}

    <!-- Back Button -->
    <div class="mt-8 text-center">
      <a
        href="/"
        class="steel-panel px-6 py-3 text-cyan-glow font-display font-bold uppercase tracking-wide hover:bg-cyan-glow hover:text-navy-950 transition-all inline-block"
      >
        ‚Üê Back to Home
      </a>
    </div>
  </main>

  <Footer />
</BaseLayout>

<style>
  .prose-steel p {
    color: rgb(var(--color-text-secondary));
  }
</style>
