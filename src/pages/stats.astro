---
import BaseLayout from '../layouts/BaseLayout.astro';
import Navigation from '../components/Navigation.astro';
import Footer from '../components/Footer.astro';
import { getClanInfo, getMembersWithStats } from '../lib/wargaming-api';
import { formatNumber, formatPercentage } from '../lib/utils';

const clan = await getClanInfo();
const members = await getMembersWithStats();

// Calculate comprehensive clan statistics
const totalBattles = members.reduce((sum, m) => sum + m.battles, 0);
const totalWins = members.reduce((sum, m) => sum + (m.battles * m.win_rate / 100), 0);
const avgWinRate = totalBattles > 0 ? (totalWins / totalBattles) * 100 : 0;

const avgDamage = members.length > 0
  ? members.reduce((sum, m) => sum + m.avg_damage, 0) / members.length
  : 0;

const avgXP = members.length > 0
  ? members.reduce((sum, m) => sum + m.avg_xp, 0) / members.length
  : 0;

const avgSurvivalRate = members.length > 0
  ? members.reduce((sum, m) => sum + m.survival_rate, 0) / members.length
  : 0;

const avgPR = members.length > 0
  ? members.reduce((sum, m) => sum + m.pr, 0) / members.length
  : 0;

// Top performers by different metrics
const topByPR = [...members].sort((a, b) => b.pr - a.pr).slice(0, 10);
const topByWR = [...members].sort((a, b) => b.win_rate - a.win_rate).slice(0, 10);
const topByDamage = [...members].sort((a, b) => b.avg_damage - a.avg_damage).slice(0, 10);
const topByBattles = [...members].sort((a, b) => b.battles - a.battles).slice(0, 10);

// Ship type distribution (simulated data - will be replaced with actual API data)
// For now, using random distribution based on typical clan composition
const shipTypeData = {
  destroyer: Math.floor(members.length * 0.25),
  cruiser: Math.floor(members.length * 0.30),
  battleship: Math.floor(members.length * 0.28),
  carrier: Math.floor(members.length * 0.12),
  submarine: Math.floor(members.length * 0.05),
};
---

<BaseLayout
  title="Battle Statistics - DawnReaver [DAWN]"
  description="Comprehensive clan statistics, performance metrics, and leaderboards for DawnReaver."
>
  <Navigation />

  <main class="max-w-[1920px] mx-auto px-8 py-12">
    <!-- Page Header -->
    <div class="mb-12 text-center">
      <h1 class="text-5xl font-display font-bold text-gold-DEFAULT mb-4 glow-gold uppercase">
        Battle Statistics
      </h1>
      <p class="text-steel-light text-xl">
        Comprehensive Performance Metrics & Combat Leaderboards
      </p>
    </div>

    <!-- Overview Stats -->
    <section class="mb-16">
      <h2 class="text-3xl font-display font-bold text-cyan-glow mb-8 uppercase text-center">
        Fleet Overview
      </h2>

      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        <div class="steel-panel p-6 alert-border">
          <div class="text-steel-light text-xs uppercase tracking-wider mb-2">Active Fleet</div>
          <div class="text-4xl font-display font-bold text-gold-DEFAULT">{formatNumber(members.length)}</div>
          <div class="text-text-tertiary text-sm mt-1">Combat Ready</div>
        </div>

        <div class="steel-panel p-6 alert-border">
          <div class="text-steel-light text-xs uppercase tracking-wider mb-2">Total Battles</div>
          <div class="text-4xl font-display font-bold text-gold-DEFAULT">{formatNumber(totalBattles)}</div>
          <div class="text-text-tertiary text-sm mt-1">Sorties Deployed</div>
        </div>

        <div class="steel-panel p-6 alert-border">
          <div class="text-steel-light text-xs uppercase tracking-wider mb-2">Clan Win Rate</div>
          <div class="text-4xl font-display font-bold text-cyan-glow glow-cyan">{formatPercentage(avgWinRate)}</div>
          <div class="text-text-tertiary text-sm mt-1">Victory Ratio</div>
        </div>

        <div class="steel-panel p-6 alert-border">
          <div class="text-steel-light text-xs uppercase tracking-wider mb-2">Average PR</div>
          <div class="text-4xl font-display font-bold text-gold-DEFAULT">{formatNumber(Math.round(avgPR))}</div>
          <div class="text-text-tertiary text-sm mt-1">Personal Rating</div>
        </div>
      </div>
    </section>

    <!-- Performance Metrics -->
    <section class="mb-16">
      <h2 class="text-3xl font-display font-bold text-cyan-glow mb-8 uppercase text-center">
        Combat Performance
      </h2>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div class="steel-panel p-6">
          <div class="text-steel-light text-xs uppercase tracking-wider mb-2">Average Damage</div>
          <div class="text-4xl font-display font-bold text-gold-DEFAULT">{formatNumber(Math.round(avgDamage))}</div>
          <div class="text-text-tertiary text-sm mt-1">Per Battle</div>
        </div>

        <div class="steel-panel p-6">
          <div class="text-steel-light text-xs uppercase tracking-wider mb-2">Average XP</div>
          <div class="text-4xl font-display font-bold text-cyan-glow">{formatNumber(Math.round(avgXP))}</div>
          <div class="text-text-tertiary text-sm mt-1">Per Battle</div>
        </div>

        <div class="steel-panel p-6">
          <div class="text-steel-light text-xs uppercase tracking-wider mb-2">Survival Rate</div>
          <div class="text-4xl font-display font-bold text-gold-DEFAULT">{formatPercentage(avgSurvivalRate)}</div>
          <div class="text-text-tertiary text-sm mt-1">Evasion Success</div>
        </div>
      </div>
    </section>

    <!-- Ship Type Distribution -->
    <section class="mb-16">
      <h2 class="text-3xl font-display font-bold text-cyan-glow mb-8 uppercase text-center">
        Fleet Composition
      </h2>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- Pie Chart -->
        <div class="steel-panel p-8 flex flex-col">
          <h3 class="text-xl font-display font-bold text-gold-DEFAULT mb-6 uppercase text-center">
            Ship Type Distribution
          </h3>
          <div class="flex-1 flex justify-center items-center" style="min-height: 400px; max-height: 500px;">
            <div style="position: relative; width: 100%; max-width: 400px; height: 100%;">
              <canvas id="shipTypeChart"></canvas>
            </div>
          </div>
        </div>

        <!-- Legend & Stats -->
        <div class="steel-panel p-8 flex flex-col">
          <h3 class="text-xl font-display font-bold text-gold-DEFAULT mb-6 uppercase">
            Breakdown by Class
          </h3>
          <div class="space-y-4">
            <div class="flex items-center justify-between p-4 bg-navy-900/50 border border-navy-700">
              <div class="flex items-center gap-3">
                <div class="w-4 h-4 rounded-full" style="background-color: #FF6B35;"></div>
                <span class="text-sm font-semibold text-text-primary">Destroyers</span>
              </div>
              <div class="flex items-center gap-4">
                <span class="text-lg font-display font-bold text-gold-DEFAULT">{shipTypeData.destroyer}</span>
                <span class="text-sm text-steel-light">({formatPercentage((shipTypeData.destroyer / members.length) * 100)})</span>
              </div>
            </div>

            <div class="flex items-center justify-between p-4 bg-navy-900/50 border border-navy-700">
              <div class="flex items-center gap-3">
                <div class="w-4 h-4 rounded-full" style="background-color: #00D9FF;"></div>
                <span class="text-sm font-semibold text-text-primary">Cruisers</span>
              </div>
              <div class="flex items-center gap-4">
                <span class="text-lg font-display font-bold text-gold-DEFAULT">{shipTypeData.cruiser}</span>
                <span class="text-sm text-steel-light">({formatPercentage((shipTypeData.cruiser / members.length) * 100)})</span>
              </div>
            </div>

            <div class="flex items-center justify-between p-4 bg-navy-900/50 border border-navy-700">
              <div class="flex items-center gap-3">
                <div class="w-4 h-4 rounded-full" style="background-color: #FFD700;"></div>
                <span class="text-sm font-semibold text-text-primary">Battleships</span>
              </div>
              <div class="flex items-center gap-4">
                <span class="text-lg font-display font-bold text-gold-DEFAULT">{shipTypeData.battleship}</span>
                <span class="text-sm text-steel-light">({formatPercentage((shipTypeData.battleship / members.length) * 100)})</span>
              </div>
            </div>

            <div class="flex items-center justify-between p-4 bg-navy-900/50 border border-navy-700">
              <div class="flex items-center gap-3">
                <div class="w-4 h-4 rounded-full" style="background-color: #9B59B6;"></div>
                <span class="text-sm font-semibold text-text-primary">Carriers</span>
              </div>
              <div class="flex items-center gap-4">
                <span class="text-lg font-display font-bold text-gold-DEFAULT">{shipTypeData.carrier}</span>
                <span class="text-sm text-steel-light">({formatPercentage((shipTypeData.carrier / members.length) * 100)})</span>
              </div>
            </div>

            <div class="flex items-center justify-between p-4 bg-navy-900/50 border border-navy-700">
              <div class="flex items-center gap-3">
                <div class="w-4 h-4 rounded-full" style="background-color: #318000;"></div>
                <span class="text-sm font-semibold text-text-primary">Submarines</span>
              </div>
              <div class="flex items-center gap-4">
                <span class="text-lg font-display font-bold text-gold-DEFAULT">{shipTypeData.submarine}</span>
                <span class="text-sm text-steel-light">({formatPercentage((shipTypeData.submarine / members.length) * 100)})</span>
              </div>
            </div>

            <div class="mt-6 p-4 bg-navy-800/50 border-t-2 border-gold-DEFAULT">
              <div class="flex items-center justify-between">
                <span class="text-sm font-bold text-steel-light uppercase">Total Members</span>
                <span class="text-2xl font-display font-bold text-gold-DEFAULT">{members.length}</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Leaderboards -->
    <section class="mb-16">
      <h2 class="text-3xl font-display font-bold text-cyan-glow mb-8 uppercase text-center">
        Top Performers
      </h2>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- Top by PR -->
        <div class="steel-panel p-6">
          <h3 class="text-2xl font-display font-bold text-gold-DEFAULT mb-6 uppercase flex items-center gap-3">
            <span class="text-3xl">üèÜ</span> Top 10 by PR
          </h3>
          <div class="space-y-2">
            {topByPR.map((member, index) => (
              <div class="flex items-center justify-between p-3 bg-navy-900/50 border border-navy-700 hover:border-gold-DEFAULT transition-all">
                <div class="flex items-center gap-3">
                  <span class="text-sm font-display font-bold text-gold-DEFAULT w-8">#{index + 1}</span>
                  <a
                    href={`/player/${member.account_id}`}
                    class="text-sm font-semibold text-text-primary hover:text-gold-DEFAULT"
                  >
                    {member.nickname}
                  </a>
                </div>
                <span class="text-base font-display font-bold text-cyan-glow">
                  {formatNumber(member.pr)}
                </span>
              </div>
            ))}
          </div>
        </div>

        <!-- Top by Win Rate -->
        <div class="steel-panel p-6">
          <h3 class="text-2xl font-display font-bold text-gold-DEFAULT mb-6 uppercase flex items-center gap-3">
            <span class="text-3xl">‚ö°</span> Top 10 by Win Rate
          </h3>
          <div class="space-y-2">
            {topByWR.map((member, index) => (
              <div class="flex items-center justify-between p-3 bg-navy-900/50 border border-navy-700 hover:border-gold-DEFAULT transition-all">
                <div class="flex items-center gap-3">
                  <span class="text-sm font-display font-bold text-gold-DEFAULT w-8">#{index + 1}</span>
                  <a
                    href={`/player/${member.account_id}`}
                    class="text-sm font-semibold text-text-primary hover:text-gold-DEFAULT"
                  >
                    {member.nickname}
                  </a>
                </div>
                <span class="text-base font-display font-bold text-cyan-glow">
                  {formatPercentage(member.win_rate)}
                </span>
              </div>
            ))}
          </div>
        </div>

        <!-- Top by Damage -->
        <div class="steel-panel p-6">
          <h3 class="text-2xl font-display font-bold text-gold-DEFAULT mb-6 uppercase flex items-center gap-3">
            <span class="text-3xl">üí•</span> Top 10 by Avg Damage
          </h3>
          <div class="space-y-2">
            {topByDamage.map((member, index) => (
              <div class="flex items-center justify-between p-3 bg-navy-900/50 border border-navy-700 hover:border-gold-DEFAULT transition-all">
                <div class="flex items-center gap-3">
                  <span class="text-sm font-display font-bold text-gold-DEFAULT w-8">#{index + 1}</span>
                  <a
                    href={`/player/${member.account_id}`}
                    class="text-sm font-semibold text-text-primary hover:text-gold-DEFAULT"
                  >
                    {member.nickname}
                  </a>
                </div>
                <span class="text-base font-display font-bold text-cyan-glow">
                  {formatNumber(Math.round(member.avg_damage))}
                </span>
              </div>
            ))}
          </div>
        </div>

        <!-- Most Battles -->
        <div class="steel-panel p-6">
          <h3 class="text-2xl font-display font-bold text-gold-DEFAULT mb-6 uppercase flex items-center gap-3">
            <span class="text-3xl">‚öì</span> Most Battles
          </h3>
          <div class="space-y-2">
            {topByBattles.map((member, index) => (
              <div class="flex items-center justify-between p-3 bg-navy-900/50 border border-navy-700 hover:border-gold-DEFAULT transition-all">
                <div class="flex items-center gap-3">
                  <span class="text-sm font-display font-bold text-gold-DEFAULT w-8">#{index + 1}</span>
                  <a
                    href={`/player/${member.account_id}`}
                    class="text-sm font-semibold text-text-primary hover:text-gold-DEFAULT"
                  >
                    {member.nickname}
                  </a>
                </div>
                <span class="text-base font-display font-bold text-cyan-glow">
                  {formatNumber(member.battles)}
                </span>
              </div>
            ))}
          </div>
        </div>
      </div>
    </section>

    <!-- Back to Home -->
    <div class="text-center">
      <a
        href="/"
        class="inline-block steel-panel px-8 py-3 text-gold-DEFAULT font-display font-bold uppercase tracking-wide hover:bg-gold-DEFAULT hover:text-navy-950 transition-all duration-300 alert-border"
      >
        ‚Üê Back to Command Center
      </a>
    </div>
  </main>

  <Footer />
</BaseLayout>

<script is:inline src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script define:vars={{ shipTypeData }}>
  // Initialize ship type distribution chart
  window.addEventListener('DOMContentLoaded', () => {
    const ctx = document.getElementById('shipTypeChart');

    if (ctx) {
      new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['Destroyers', 'Cruisers', 'Battleships', 'Carriers', 'Submarines'],
          datasets: [{
            data: [
              shipTypeData.destroyer,
              shipTypeData.cruiser,
              shipTypeData.battleship,
              shipTypeData.carrier,
              shipTypeData.submarine
            ],
            backgroundColor: [
              '#FF6B35',  // Destroyers - Orange
              '#00D9FF',  // Cruisers - Cyan
              '#FFD700',  // Battleships - Gold
              '#9B59B6',  // Carriers - Purple
              '#318000',  // Submarines - Green
            ],
            borderColor: '#1a2332',
            borderWidth: 4,
            hoverBorderColor: '#FFD700',
            hoverBorderWidth: 5,
            hoverOffset: 20,
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          aspectRatio: 1,
          cutout: '50%',
          plugins: {
            legend: {
              display: false,
            },
            tooltip: {
              enabled: true,
              backgroundColor: 'rgba(26, 35, 50, 0.98)',
              titleColor: '#FFD700',
              titleFont: {
                size: 16,
                weight: 'bold'
              },
              bodyColor: '#C8D0E0',
              bodyFont: {
                size: 14
              },
              borderColor: '#00D9FF',
              borderWidth: 2,
              padding: 16,
              displayColors: true,
              boxWidth: 12,
              boxHeight: 12,
              callbacks: {
                label: function(context) {
                  const label = context.label || '';
                  const value = context.parsed;
                  const total = context.dataset.data.reduce((a, b) => a + b, 0);
                  const percentage = ((value / total) * 100).toFixed(1);
                  return ` ${label}: ${value} members (${percentage}%)`;
                }
              }
            }
          },
          animation: {
            animateRotate: true,
            animateScale: true,
            duration: 1500,
            easing: 'easeInOutQuart'
          },
          layout: {
            padding: 20
          }
        }
      });
    }
  });
</script>
